# API-сервис для работы ресторанов

Серверное приложение для автоматизации работы ресторанов и кафе-баров.

## Оглавление

- [Возможности](#возможности)
- [Технологии](#технологии)
- [API Документация](#api-документация)
- [Структура проекта](#структура-проекта)
- [База данных](#база-данных)
- [Настройка окружения](#настройка-окружения)
- [Запуск проекта](#запуск-проекта)
- [Миграции](#миграции)
- [Тесты](#тесты)

---

## Возможности

### Пользователи
- Создание пользователей (регистрация)
- Изменение данных пользователя
- Удаление аккаунтов
- Получение списка пользователей
- Разделение по ролям (администратор, официант, повар, бармен, клиент)

### Управление меню
- Просмотр меню и отдельных позиций
- Изменение меню
- Загрузка изображений позиций меню
- Рекомендации по самым популярным блюдам и напиткам

### Состав позиций меню
- Просмотр составов
- Изменение состава

### Управление заказами
- Просмотр заказов
- Создание заказов
- Разделение на столики
- Привязка персонала к заказу
- Изменение статуса заказа

### Управление отзывами
- Просмотр отзывов
- Создание и изменение отзывов
- Ответы на отзывы от администратора

### Управление сменами персонала
- Просмотр смен
- Создание, назначение и изменение смен

### Бронирование столиков
- Создание брони
- Получение брони
- Изменение брони
- Автоматическое завершение по времени

### Статистика персонала
- Получение статистики по работе персонала, общий рейтинг

---

## Аутентификация и авторизация
- JWT токены
- Ролевая модель доступа
- Защита эндпоинтов

---

## Технологии

- **Backend:** FastAPI, SQLAlchemy, Pydantic, Asyncio
- **База данных:** PostgreSQL, Redis
- **Аутентификация:** JWT, bcrypt
- **Планировщик:** APScheduler
- **Облачное хранилище изображений:** Yandex Cloud
- **Расылка событий:** WebSockets
- **Документация API:** Swagger
- **Миграции:** Alembic
- **Тестирование:** PyTest
- **Контейнеризация:** Docker, docker-compose

---

## API Документация

После запуска проекта полная документация API доступна через Swagger UI:
- **Swagger UI:** http://localhost:8000/docs

Документация включает все эндпоинты, схемы запросов/ответов и возможность тестирования API.

---

## Структура проекта

```
app/
  dependencies/
    cache.py
  migrations/
  realtime/
    websocket_manager.py
    events.py
  routers/
  models/
  schemas/
  services/
  scheduler/
    scheduler.py
  config.py
  database.py
  main.py
  redis.py
tests/
  test_routers/
  test_services/
  conftest.py
  mock_scheduler.py
scripts/
  start.sh
alembic.ini
docker-compose.yml
Dockerfile
README.md
requirements.py
```

---

## База данных

Используется PostgreSQL с асинхронным подключением через SQLAlchemy.
Архитектура БД включает таблицы для управления пользователями, меню, заказами, бронированиями, ингредиентами, сменами, назначениями и отзывами.

Миграции управляются через Alembic.

---

## Настройка окружения

Перед первым запуском создайте файл `.env` в корне проекта:

```env
# База данных
DB_HOST=localhost
DB_PORT=5432
DB_NAME=your-db-name
DB_USER=your-user-name
DB_PASSWORD=your-db-password

# Redis
REDIS_URL=redis://redis:6379

# JWT
HASH_SECRET_KEY=your-secret-key
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=expiration-time

# Yandex Cloud (для загрузки изображений)
YANDEX_ACCESS_KEY=your-access-key
YANDEX_SECRET_KEY=your-secret-key
YANDEX_BUCKET_NAME=your-bucket-name
YANDEX_ENDPOINT="https://storage.yandexcloud.net"

# Swagger
SWAGGER_PASSWORD=your-swagger-password
```
Все переменные обязательны для работы приложения.

---

## Запуск проекта

### 1. Клонировать репозиторий
```bash
git clone https://github.com/koliadav1/cafebar-server.git
cd cafebar-server
```

### 2. Настроить окружение
- Создайте .env файл (см. раздел "Настройка окружения")

### 3. Запустить контейнеры
```bash
docker-compose up --build
```

### 4. Приложение будет доступно по адресу:
- API: http://localhost:8000
- Swagger-документация: http://localhost:8000/docs

---

## Миграции

Создание новой миграции:  
```bash
docker-compose exec web alembic revision --autogenerate -m "migration name"
```

Применение миграций:  
```bash
docker-compose exec web alembic upgrade head
```

---

## Тесты

Запуск тестов: 
```bash
docker-compose exec web pytest
```
Тесты покрывают 68% кода. Тестируются эндпоинты и сервисы аутентификации, бронирований, ингредиентов, меню, заказов, отзывов и пользователей.

---

## Разработка и возможности для улучшения

Для дополнительной настройки и кастомизации системы можно:
- Добавить refresh-token для улучшения работы аутентификации
- Расширить систему аналитики
- Расширить систему рекомендаций
- Расширить систему смен
- Заменить APScheduler на Celery
- Добавить интеграцию со сторонними API (оплата)
- Добавить складской учет